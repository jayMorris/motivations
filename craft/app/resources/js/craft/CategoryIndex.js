Craft.CategoryIndex=Craft.BaseElementIndex.extend({editableGroups:null,$newCategoryBtnGroup:null,$newCategoryBtn:null,afterInit:function(){this.editableGroups=[];for(var t=0;t<Craft.editableCategoryGroups.length;t++){var e=Craft.editableCategoryGroups[t];this.getSourceByKey("group:"+e.id)&&this.editableGroups.push(e)}this.base()},getDefaultSourceKey:function(){if("index"==this.settings.context&&"undefined"!=typeof defaultGroupHandle)for(var t=0;t<this.$sources.length;t++){var e=$(this.$sources[t]);if(e.data("handle")==defaultGroupHandle)return e.data("key")}return this.base()},onSelectSource:function(){var t=this.$source.data("handle");if(this.editableGroups.length){this.$newCategoryBtnGroup&&this.$newCategoryBtnGroup.remove();var e;if(t)for(var n=0;n<this.editableGroups.length;n++)if(this.editableGroups[n].handle==t){e=this.editableGroups[n];break}this.$newCategoryBtnGroup=$('<div class="btngroup submit"/>');var r;if(e){var i=this._getGroupTriggerHref(e),a="index"==this.settings.context?Craft.t("New category"):Craft.t("New {group} category",{group:e.name});this.$newCategoryBtn=$('<a class="btn submit add icon" '+i+">"+Craft.escapeHtml(a)+"</a>").appendTo(this.$newCategoryBtnGroup),"index"!=this.settings.context&&this.addListener(this.$newCategoryBtn,"click",function(t){this._openCreateCategoryModal(t.currentTarget.getAttribute("data-id"))}),this.editableGroups.length>1&&(r=$('<div class="btn submit menubtn"></div>').appendTo(this.$newCategoryBtnGroup))}else this.$newCategoryBtn=r=$('<div class="btn submit add icon menubtn">'+Craft.t("New category")+"</div>").appendTo(this.$newCategoryBtnGroup);if(r){for(var o='<div class="menu"><ul>',n=0;n<this.editableGroups.length;n++){var s=this.editableGroups[n];if("index"==this.settings.context||s!=e){var i=this._getGroupTriggerHref(s),a="index"==this.settings.context?s.name:Craft.t("New {group} category",{group:s.name});o+="<li><a "+i+'">'+Craft.escapeHtml(a)+"</a></li>"}}o+="</ul></div>";var d=$(o).appendTo(this.$newCategoryBtnGroup),u=new Garnish.MenuBtn(r);"index"!=this.settings.context&&u.on("optionSelect",$.proxy(function(t){this._openCreateCategoryModal(t.option.getAttribute("data-id"))},this))}this.addButton(this.$newCategoryBtnGroup)}if("index"==this.settings.context&&"undefined"!=typeof history){var g="categories";t&&(g+="/"+t),history.replaceState({},"",Craft.getUrl(g))}this.base()},_getGroupTriggerHref:function(t){return"index"==this.settings.context?'href="'+Craft.getUrl("categories/"+t.handle+"/new")+'"':'data-id="'+t.id+'"'},_openCreateCategoryModal:function(t){if(!this.$newCategoryBtn.hasClass("loading")){for(var e,n=0;n<this.editableGroups.length;n++)if(this.editableGroups[n].id==t){e=this.editableGroups[n];break}if(e){this.$newCategoryBtn.addClass("inactive");var r=this.$newCategoryBtn.text();this.$newCategoryBtn.text(Craft.t("New {group} category",{group:e.name})),new Craft.ElementEditor({hudTrigger:this.$newCategoryBtnGroup,elementType:"Category",locale:this.locale,attributes:{groupId:t},onBeginLoading:$.proxy(function(){this.$newCategoryBtn.addClass("loading")},this),onEndLoading:$.proxy(function(){this.$newCategoryBtn.removeClass("loading")},this),onHideHud:$.proxy(function(){this.$newCategoryBtn.removeClass("inactive").text(r)},this),onSaveElement:$.proxy(function(e){var n="group:"+t;this.sourceKey!=n&&this.selectSourceByKey(n),this.selectElementAfterUpdate(e.id),this.updateElements()},this)})}}}}),Craft.registerElementIndexClass("Category",Craft.CategoryIndex);