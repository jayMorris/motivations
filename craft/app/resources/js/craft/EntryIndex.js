Craft.EntryIndex=Craft.BaseElementIndex.extend({publishableSections:null,$newEntryBtnGroup:null,$newEntryBtn:null,afterInit:function(){this.publishableSections=[];for(var t=0;t<Craft.publishableSections.length;t++){var e=Craft.publishableSections[t];this.getSourceByKey("section:"+e.id)&&this.publishableSections.push(e)}this.base()},getDefaultSourceKey:function(){if("index"==this.settings.context&&"undefined"!=typeof defaultSectionHandle){if("singles"==defaultSectionHandle)return"singles";for(var t=0;t<this.$sources.length;t++){var e=$(this.$sources[t]);if(e.data("handle")==defaultSectionHandle)return e.data("key")}}return this.base()},onSelectSource:function(){var t;if(t="singles"==this.$source.data("key")?"singles":this.$source.data("handle"),this.publishableSections.length){this.$newEntryBtnGroup&&this.$newEntryBtnGroup.remove();var e;if(t)for(var n=0;n<this.publishableSections.length;n++)if(this.publishableSections[n].handle==t){e=this.publishableSections[n];break}this.$newEntryBtnGroup=$('<div class="btngroup submit"/>');var i;if(e){var s=this._getSectionTriggerHref(e),r="index"==this.settings.context?Craft.t("New entry"):Craft.t("New {section} entry",{section:e.name});this.$newEntryBtn=$('<a class="btn submit add icon" '+s+">"+r+"</a>").appendTo(this.$newEntryBtnGroup),"index"!=this.settings.context&&this.addListener(this.$newEntryBtn,"click",function(t){this._openCreateEntryModal(t.currentTarget.getAttribute("data-id"))}),this.publishableSections.length>1&&(i=$('<div class="btn submit menubtn"></div>').appendTo(this.$newEntryBtnGroup))}else this.$newEntryBtn=i=$('<div class="btn submit add icon menubtn">'+Craft.t("New entry")+"</div>").appendTo(this.$newEntryBtnGroup);if(i){for(var a='<div class="menu"><ul>',n=0;n<this.publishableSections.length;n++){var o=this.publishableSections[n];if("index"==this.settings.context||o!=e){var s=this._getSectionTriggerHref(o),r="index"==this.settings.context?o.name:Craft.t("New {section} entry",{section:o.name});a+="<li><a "+s+'">'+Craft.escapeHtml(r)+"</a></li>"}}a+="</ul></div>";var l=$(a).appendTo(this.$newEntryBtnGroup),h=new Garnish.MenuBtn(i);"index"!=this.settings.context&&h.on("optionSelect",$.proxy(function(t){this._openCreateEntryModal(t.option.getAttribute("data-id"))},this))}this.addButton(this.$newEntryBtnGroup)}if("index"==this.settings.context&&"undefined"!=typeof history){var d="entries";t&&(d+="/"+t),history.replaceState({},"",Craft.getUrl(d))}this.base()},_getSectionTriggerHref:function(t){return"index"==this.settings.context?'href="'+Craft.getUrl("entries/"+t.handle+"/new")+'"':'data-id="'+t.id+'"'},_openCreateEntryModal:function(t){if(!this.$newEntryBtn.hasClass("loading")){for(var e,n=0;n<this.publishableSections.length;n++)if(this.publishableSections[n].id==t){e=this.publishableSections[n];break}if(e){this.$newEntryBtn.addClass("inactive");var i=this.$newEntryBtn.text();this.$newEntryBtn.text(Craft.t("New {section} entry",{section:e.name})),new Craft.ElementEditor({hudTrigger:this.$newEntryBtnGroup,elementType:"Entry",locale:this.locale,attributes:{sectionId:t},onBeginLoading:$.proxy(function(){this.$newEntryBtn.addClass("loading")},this),onEndLoading:$.proxy(function(){this.$newEntryBtn.removeClass("loading")},this),onHideHud:$.proxy(function(){this.$newEntryBtn.removeClass("inactive").text(i)},this),onSaveElement:$.proxy(function(e){var n="section:"+t;this.sourceKey!=n&&this.selectSourceByKey(n),this.selectElementAfterUpdate(e.id),this.updateElements()},this)})}}}}),Craft.registerElementIndexClass("Entry",Craft.EntryIndex);